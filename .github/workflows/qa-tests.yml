name: ðŸ§ª QA Tests
permissions:
  contents: read
on:
  push: {}
  workflow_call: {}

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout zen-demo-ruby
        uses: actions/checkout@v5
        with:
          repository: Aikido-demo-apps/zen-demo-ruby
          path: zen-demo-ruby
          submodules: true
          ref: dev-testing
      
      - name: Checkout firewall-ruby
        uses: actions/checkout@v5
        with:
          path: zen-demo-ruby/tmp/firewall-ruby


      # We need Ruby + Bundler on the runner to regenerate Gemfile.lock
      - name: Set up Ruby (same as zen-demo-ruby)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.8'
          bundler-cache: false

      - name: Patch Gemfile to use the local firewall-ruby directory
        working-directory: zen-demo-ruby
        run: |
          
          echo "Gemfile before patch:"
          grep -n "aikido-zen" Gemfile || true
      
          # Replace the aikido-zen dependency to use the local path
          sed -i "s/^gem ['\"]aikido-zen['\"].*/gem 'aikido-zen', path: 'tmp\/firewall-ruby'/g" Gemfile

          echo "Gemfile after patch:"
          grep -n "aikido-zen" Gemfile
          
          # Make sure Bundler installs locally (not system-wide)
          bundle config set path 'vendor/bundle'

          # IMPORTANT: regenerate Gemfile.lock so it's in sync with Gemfile
          bundle install

          # Update Dockerfile to copy the firewall-ruby directory
          sed -i "s/^COPY Gemfile Gemfile.lock ./COPY Gemfile Gemfile.lock tmp\//g" Dockerfile
      
      - name: Print Dockerfile
        run: |
          echo "Dockerfile:"
          cat Dockerfile

      - name: Run Firewall QA Tests
        uses: AikidoSec/firewall-tester-action@releases/v1
        with:
          dockerfile_path: ./zen-demo-ruby/Dockerfile
          app_port: 3000
          sleep_before_test: 30
          extra_args: "-e RAILS_ENV=test -e AIKIDO_CLIENT_IP_HEADER=HTTP_X_FORWARDED_FOR"
       
